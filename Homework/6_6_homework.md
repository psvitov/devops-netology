# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB

### Ответ:

Для остановки запроса пользователя необходимо найти его запрос командой [db.currentOp()](https://www.mongodb.com/docs/manual/reference/method/db.currentOp/)

После нахождения запроса необходимо завершить его командой [db.killOp(opid)](https://www.mongodb.com/docs/manual/reference/method/db.killOp/)

Для решения проблемы в будущем необходимо изучить запрос, который привел к зависанию и перестроить индексы, связанные с данным запросом.

## Задача 2

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи

Как вы думаете, в чем может быть проблема?

### Ответ:

При росте отношения записанных значений к истекшим вероятнее всего происходит переполнение записей в оперативной памяти. Так же на это указывает, что Redis блокирует запись, так как там не хватает места. Необходимо увеличивать пропроционально объем памяти при масштабировании сервиса на N реплик, а так же [оптимизировать использование памяти ](https://redis.io/docs/reference/optimization/memory-optimization/)

## Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения данной проблемы вы можете предложить?

### Ответ:

Вероятнее всего это указывает на проблемы с сетевым соединением, так как при увеличении количества записей увеличился и объем передаваемых данных.

Необходимо изменить следующие показатели в сторону увеличения:

- net_read_timeout - до 60 секунд или более, достаточного для завершения передачи данных;
- connect_timeout - увеличить его до 10 секунд, возможно, больше, если присутствует медленное соединение;
- max_allowed_packet - может возникнуть проблема со значениями BLOB, превышающими значение этого показателя.

Так же стоит попробовать увеличить ресурсы сервера.

## Задача 4


Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили данную проблему?

### Ответ:

Рабочему процессу не хватает оперативной памяти, вероятнее всего СУБД "съедает её всю". Необходимо увеличить объемы памяти и ограничить потребление памяти для СУБД, для предотвращения потребления все оперативной памяти, что и приводит к недоступности СУБД
